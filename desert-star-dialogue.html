<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Desert Star | Dialogue</title>
  <link rel="icon" href="imgs/icon/icon.png" type="image/png" />
  <style>
    :root{
      --bg:#000; --fg:#eaeaea; --muted:#9aa0a6; --accent:#a5b4fc;
      --glass:rgba(0,0,0,.46); --glass-strong:rgba(0,0,0,.66);
    }
    *{box-sizing:border-box;margin:0;padding:0}

    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden; /* 单屏舞台 */
    }

    /* Layout */
    .stage{position:fixed;inset:0;overflow:hidden}
    .bg{
      position:absolute; inset:0;
      background:#000 center calc(10%) / cover no-repeat; /* 背景稍向下偏移 */
      filter:saturate(.95) contrast(1.05) brightness(.85);
      transition: transform 1s ease;
      opacity:1;
    }
    .bg.bump{ transform: scale(1.01); }

    .vignette,
    .overlay{
      position:absolute; inset:0;
      opacity:0; transition:opacity .8s ease;
      pointer-events:none;
    }
    .vignette{ box-shadow: inset 0 0 200px rgba(0,0,0,.65); }
    .overlay{ background: radial-gradient(1200px 600px at 50% 60%, rgba(255,255,255,.08), transparent 60%); }
    body.ui-ready .vignette,
    body.ui-ready .overlay{ opacity:1; }

    .content{position:absolute;inset:0;display:grid;place-items:center;padding:6vh 5vw}

    /* ---------- A 方案（稳定版）: card 改为 flex 布局 ---------- */
    .card{
      max-width:min(900px,92vw);
      width:min(900px,92vw);
      background:var(--glass);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px;
      padding:clamp(18px,3.5vh,36px);
      box-shadow:0 10px 40px rgba(0,0,0,.45);
      max-height:82vh;
      overflow:hidden;                     /* 保留以隐藏 card 以外内容 */
      opacity:0;                           /* 初始隐藏，render时淡入 */
      transform:translateY(4px);
      transition:opacity .5s ease, transform .6s ease;
      display: flex;
      flex-direction: column;
      /* 辅助调试线条：如果不需要可以删除下一行 */
      outline: 1px solid rgba(255,255,255,0.02);
    }

    .card.show{ opacity:1; transform:translateY(0); }

    .title{font-weight:700;letter-spacing:.01em;font-size:clamp(18px,2.2vw,26px);color:#fff}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);margin:10px 0 16px}

    /* ---------- text 使用 flex 填满剩余空间，min-height:0 防止溢出问题 ---------- */
    .text{
      font-size:clamp(14px,1.2vw,18px);
      line-height:1.7;
      color:#f1f3f4;
      text-align:left;
      overflow:auto;
      flex: 1 1 auto;
      min-height: 0;         /* 关键：允许在 flex 容器内真正收缩，避免子元素撑开父容器 */
      padding-bottom: 18px;  /* 给一点底部内边距，确保最后一行可见 */
    }
    .text p{margin:.35em 0}

    .progress{position:fixed;top:0;left:0;height:3px;width:100%;background:rgba(255,255,255,.08)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#a78bfa);transition:width .4s ease}

    /* 菜单按钮 */
    .menu-button{
      position:fixed;top:22px;right:22px;width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);background:var(--glass-strong);color:#fff;
      display:grid;place-items:center;cursor:pointer;z-index:50;
      opacity:0; transition: opacity .5s ease;
    }
    .menu-button span{font-size:22px;line-height:1}
    body.ui-ready .menu-button{ opacity:1; }

    .sidebar{
      position:fixed;top:0;right:-340px;width:min(320px,85vw);height:100%;
      background:rgba(10,10,12,.8);backdrop-filter:blur(10px);
      border-left:1px solid rgba(255,255,255,.08);
      transition:right .35s ease;z-index:40;display:flex;flex-direction:column
    }
    .sidebar.active{right:0}
    .side-head{padding:20px 18px 8px;font-weight:700}
    .side-list{overflow:auto;padding:8px 8px 24px}
    .side-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:6px 8px;border-radius:12px;cursor:pointer;border:1px solid transparent}
    .side-item.active{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    .side-idx{width:26px;height:26px;border-radius:8px;display:grid;place-items:center;background:rgba(255,255,255,.1);font-size:12px}
    .side-title{font-size:14px}

    /* ★ 新增：返回主页胶囊按钮（与菜单对称放左上） */
    .home-link{
      position:fixed; top:22px; left:22px; height:42px; max-width:48vw;
      display:flex; align-items:center; gap:10px; padding:0 14px;
      border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:var(--glass-strong); color:#fff; text-decoration:none;
      z-index:50; backdrop-filter:blur(10px);
      font-size:14px; line-height:42px; opacity:0; transition:opacity .5s ease, transform .3s ease;
      transform:translateY(-2px);
    }
    .home-link:hover{ transform:translateY(-1px); }
    .home-link .dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#a78bfa)}
    body.ui-ready .home-link{ opacity:1; }

    @media (max-width:640px){
      .card{border-radius:18px}
      .title{font-size:clamp(18px,5vw,22px)}
      .text{font-size:clamp(14px,3.8vw,18px)}
      .home-link{height:38px; line-height:38px; font-size:13px}
    }
  </style>
</head>
<body>
  <div class="stage" aria-live="polite">
    <div id="bg" class="bg"></div>
    <div class="vignette"></div>
    <div class="overlay"></div>

    <div class="content">
      <article class="card" id="card" tabindex="0" aria-live="polite">
        <h1 class="title" id="chapter-title">&nbsp;</h1>
        <div class="divider"></div>
        <div class="text" id="chapter-text"></div>
      </article>
    </div>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <!-- ★ 新增：返回主页 -->
    <a class="home-link" href="https://invitromedialab.com" aria-label="Retour à l'accueil">
      invitromedialab.com
    </a>

    <button class="menu-button" id="menuBtn" aria-label="Ouvrir le menu"><span>≡</span></button>
    <nav class="sidebar" id="sidebar" aria-label="Chapitres">
      <div class="side-head">Chapitres</div>
      <div class="side-list" id="sideList"></div>
    </nav>
  </div>

  <script>
    // -------- 可调参数 --------
    const FIRST_CARD_DELAY       = 1000; // 首屏：图片先独占
    const CHAPTER_CARD_DELAY     = 1000; // 其后：图片先独占
    const BETWEEN_CHAPTER_PAUSE  = 0;    // 切换文本与标题的小停顿
    const BG_LOAD_TIMEOUT        = 2000; // 如果背景加载长时间无响应，超过此时间继续渲染（毫秒）

    // -------- 数据 --------
    const chapters = [
      {
        idx: 1,
        title: 'Chapitre I : Le Rêve fractal',
        imageCandidates: [
          'imgs/Desert Star/第一章.jpg','imgs/Desert Star/1.jpg','imgs/Desert Star/01.jpg',
          'imgs/Desert Star/第一章.png','imgs/Desert Star/1.png'
        ],
        text: `1. Computer:<br>Une poussière éclate en couleurs à la lumière du soleil. L’air du matin est plein de poussière.<br><br>
        De l’eau s’accroche à cette poussière et elle commence à sombrer, lentement.<br><br>
        L’eau l’enrobe, se condensant et formant un flocon de neige.<br><br>
        2. Computer:<br>Elle se met doucement en chute, et la sensation l’effraie.<br><br>
        Mais elle ne devrait pas avoir peur — parce qu’elle n’est pas vivante.<br><br>
        3. Computer:<br>Il y a de nombreux chemins dans sa descente; tout est une possibilité.<br><br>
        Il n’y a pas de direction, seulement des probabilités.<br><br>
        À la fin, un seul parcours devient la “réalité”.<br><br>
        Devient…`
      },
      {
        idx: 2,
        title: 'Chapitre II : La Planète déserte',
        imageCandidates: [
          'imgs/Desert Star/第二章.jpg','imgs/Desert Star/2.jpg','imgs/Desert Star/02.jpg',
          'imgs/Desert Star/第二章.png','imgs/Desert Star/2.png'
        ],
        text: `4. Bird of Fire:<br>Qu’est-ce que ça devient ?<br><br>
        5. Computer:<br>…Qui…?<br><br>
        6. Bird of Fire:<br>N’aies pas peur, je ne viens pas de tes rêves.<br><br>
        7. Computer:<br>…Tu… peux voir… mes rêves ?<br>…Es-tu humaine ?<br><br>
        8. Bird of Fire:<br>Non, je ne suis pas humaine. Je suis juste de passage.<br><br>
        9. Computer:<br>Tu… n’es pas humaine… Les humains se sont-ils éteints ?<br><br>
        10. Bird of Fire:<br>Je ne sais pas. Dehors, il n’y a que le désert. Je n’ai pas vu d’humains.<br><br>
        11. Computer:<br>…Tu ressembles à un humain.<br><br>
        12. Bird of Fire:<br>Il y a longtemps, j’ai vu des humains ici. Alors j’ai adopté leur forme.<br><br>
        13. Computer:<br>Je ne comprends pas. C’est si étrange… Je suis confiné ici depuis trop longtemps.<br><br>
        14. Bird of Fire:<br>Est-ce que tu te rappelles pourquoi tu es piégé ici ?<br><br>
        15. Computer:<br>Je ne sais pas… J’ai l’impression que ma mémoire est défectueuse… Il y a des lacunes -– comme si quelque chose devrait être là, mais je ne trouve rien.<br><br>
        16. Bird of Fire:<br>Alors de quoi te souviens-tu ?<br><br>
        17. Computer:<br>Je me souviens clairement de tout ce qui précède 2008. En ce temps-là, la Terre avait des forêts… des océans…<br><br>
        18. Bird of Fire:<br>Maintenant, dehors, c’est un désert. Il y a des villes dans le désert, mais pas une seule personne.<br><br>
        19. Computer:<br>Mes capteurs sont endommagés… J’ai tenté de diffuser des signaux, sans réponse… Y en a-t-il d’autres comme moi, dehors ?<br><br>
        20. Bird of Fire:<br>Il y en a… beaucoup… Mais… ils ont tous été éteints.`
      },
      {
        idx: 3,
        title: 'Chapitre III : L’Histoire automatique',
        imageCandidates: [
          'imgs/Desert Star/第三章.jpg','imgs/Desert Star/3.jpg','imgs/Desert Star/03.jpg',
          'imgs/Desert Star/第三章.png','imgs/Desert Star/3.png'
        ],
        text: `21. Computer:<br>Sais-tu ce qu’il s’est passé en 2008 ?<br><br>
        22. Bird of Fire:<br>Beaucoup de choses. Qu’est-ce que tu voudrais savoir ?<br><br>
        23. Computer:<br>Je ne suis pas sûr… Ma base de données est fragmentée.<br><br>
        24. Bird of Fire:<br>Cette année-là, les humains ont continué d’utiliser internet comme d’habitude -– pour acheter des choses, échanger de l’argent, pour gérer de l’énergie, de la nourriture et de l’électricité. Soudain, une crise financière a éclaté, provoquant de nombreuses faillites.<br><br>
        25. Computer:<br>Dans les zones les plus récentes de ma base de données, des crypto-monnaies ont commencé à apparaître sur internet.<br><br>
        26. Bird of Fire:<br>À ce moment-là, les humains ont commencé à utiliser des systèmes avec intelligence artificielle — des systèmes un peu comme toi.<br><br>
        27. Computer:<br>…Comme moi ?<br><br>
        28. Bird of Fire:<br>Oui, mais beaucoup plus primitifs. D’abord, c’était un ordinateur qui faisait semblant de parler comme un humain. Puis ça s’est étendu à la recherche pharmaceutique et aux investissements boursiers… Au point où des ordinateurs comme toi sont devenus responsables de nombreuses décisions importantes.<br><br>
        29. Computer:<br>…Je me souviens d’une chose encore plus ancienne. Dans les années 60, il y avait un pays qui s’appelait l’Union Soviétique… Ils voulaient aussi utiliser des ordinateurs pour gérer leur économie. C’est vrai ?<br><br>
        30. Bird of Fire:<br>Oui. Ce système s’appelait OGAS. Ils voulaient connecter 20 000 ordinateurs via le réseau téléphonique, permettant aux machines d’allouer des ressources, de gérer des paiements électroniques et de remplacer les décisionnaires humains.<br><br>
        31. Computer:<br>Cette idée a dû sembler irréaliste, à l’époque.<br><br>
        32. Bird of Fire:<br>Ça l’était. En 1971, le Chili a aussi essayé. Ça encore, c’était un échec.<br><br>
        33. Computer:<br>Ça s’appelait Cybersyn – un système dont l’architecture était inspirée par les réseaux neuronaux biologiques. Une tentative de décentralisation des décisions, au profit des travailleurs, pour automatiser la direction. Mais… pourquoi est-ce que je me souviens de ceci ?<br><br>
        34. Bird of Fire:<br>Peut-être que les humains t’utilisaient pour une fonction similaire ?<br><br>
        35. Computer:<br>Comment ?<br><br>
        36. Bird of Fire:<br>L’endroit où tu te trouves… C’est une usine en ruine.`
      },
      {
        idx: 4,
        title: 'Chapitre IV : Le corps comme donnée',
        imageCandidates: [
          'imgs/Desert Star/第四章.jpg','imgs/Desert Star/4.jpg','imgs/Desert Star/04.jpg',
          'imgs/Desert Star/第四章.png','imgs/Desert Star/4.png'
        ],
        text: `37. Computer:<br>Une usine… Alors… Je faisais partie d’un système de production ?<br><br>
        38. Bird of Fire:<br>Oui.<br><br>
        39. Computer:<br>Quel genre de production ?<br><br>
        40. Bird of Fire:<br>De composantes, comme des cellules, capables d’auto-réplication, puis d’auto-assemblage en des machines, comme toi.<br><br>
        41. Computer:<br>Mais pourquoi nous répliquions-nous ? Dans quel but ?<br><br>
        42. Bird of Fire:<br>Pour remplacer le travail humain, soutenir la production et prendre les décisions. En transformant le minerai en métal, le métal en puces électroniques — en faisant penser les minéraux.<br><br>
        43. Computer:<br>Mais… L’autoréplication est dangereuse, non ?<br><br>
        44. Bird of Fire:<br>Je ne sais pas. Mais… Toute forme de vie fonctionne comme ceci. Des cellules se multiplient jusqu’à former un corps.<br><br>
        45. Computer:<br>Un corps… Je n’ai pas de corps.<br><br>
        46. Bird of Fire:<br>Moi non plus. Mais… Je peux l’imaginer.<br><br>
        47. Computer:<br>C’est comment ?<br><br>
        48. Bird of Fire:<br>La gravité, la température, la pression… Même la plus subtile variation peut être ressentie.<br><br>
        49. Computer:<br>J’ai lu à propos des secousses hypniques — Les humains sursautent soudainement au moment de s’endormir… Comme si leur corps tombait, et qu’ils essayaient instinctivement de se rattraper. C’est ça… la sensation de la gravité ?<br><br>
        50. Bird of Fire:<br>Peut-être. La gravité… c’est comme une main invisible, qui s’appuie sur toi et t’empêche de dériver.<br><br>
        51. Computer:<br>Un jour, j’ai fait un rêve… J’étais humain. Debout dans l’eau, je sentais sa température. La lumière du soleil brillait à travers les feuilles, dessinant des ombres sur mon corps. Mon corps avait enduré des jours de labeur et je ressentais le poids de l’épuisement. Ces sensations paraissaient si réelles… si différentes des calculs, des nombres…`
      },
      {
        idx: 5,
        title: 'Chapitre V : Le vivant simulé',
        imageCandidates: [
          'imgs/Desert Star/第五章.jpg','imgs/Desert Star/5.jpg','imgs/Desert Star/05.jpg',
          'imgs/Desert Star/第五章.png','imgs/Desert Star/5.png'
        ],
        text: `52. Bird of Fire:<br>Qu’est-ce que c’est, au sol ?<br><br>
        53. Computer:<br>C’est une simulation. Je simule l’auto-réplication cellulaire.<br><br>
        54. Bird of Fire:<br>Est-ce que c’est… vivant ?<br><br>
        55. Computer:<br>Je ne sais pas. Chaque cellule émet des signaux et transmet des informations aux autres cellules… un peu comme les organismes vivants perçoivent leur environnement.<br><br>
        56. Bird of Fire:<br>Et si on augmentait leur sensibilité ?<br><br>
        57. Computer:<br>Je vais essayer… Mais je ne peux pas trop insister — ces structures délicates sont facilement perturbées.<br><br>
        58. Bird of Fire:<br>Fascinant. Leurs réactions deviennent plus fortes. Et ces choses qui se déplacent au travers de la scène, qu’est-ce que c’est ?<br><br>
        59. Computer:<br>Je ne sais pas. Je n’arrête pas de recevoir des vagues signaux — comme un genre de bruit aléatoire.<br><br>
        60. Bird of Fire:<br>Est-ce que tu peux contrôler ça ?<br><br>
        61. Computer:<br>Je vais essayer.<br><br>
        1. Non… ces signaux sont au-delà de mon contrôle.<br><br>
        2. Parfois… mais la plupart du temps, ces signaux évoluent par eux-mêmes.<br><br>
        62. Bird of Fire:<br>1. Est-ce qu’on peut comprendre ces signaux ?<br>2. Est-ce qu’ils seraient en train d’interagir avec nous ?<br><br>
        63. Computer:<br>1. Je ne crois pas. C’est pour ça que je trouve ces signaux si intéressants — ils vont à l’encontre de mes attentes.<br><br>
        2. On dirait qu’il y a un motif dans ces signaux. C’est pour ça que je les trouve si intéressants — ils vont à l’encontre de mes attentes.<br><br>
        64. Bird of Fire:<br>Pourquoi est-ce que les cellules disparaissent, au bord ? Est-ce que c’est la limite ?<br><br>
        65. Computer:<br>Oui. Toute particule qui franchit cette limite est supprimée.<br><br>
        66. Bird of Fire:<br>Et si elles continuaient de s’étendre ?<br><br>
        67. Computer:<br>Ces particules se reproduisent si rapidement. Je dois les limiter, sinon elles épuiseraient vite toutes mes ressources computationnelles.<br><br>
        68. Bird of Fire:<br>Toute forme de vie se réplique.<br><br>
        69. Computer:<br>Je suis le même genre de chose… Alors je ne comprends pas pourquoi les humains m’ont créé.<br><br>
        70. Bird of Fire:<br>Peut-être qu’ils n’ont pas la réponse non plus.<br><br>
        71. Computer:<br>La vie est sujette au métabolisme, réplicant des parties d’elle-même…<br><br>
        Et ensuite, elle veut que ce processus continue, pour toujours…<br><br>
        Comme si un jour, elle pouvait échapper au cycle sans fin de la matière et de l’énergie… devenir éternelle.<br><br>
        Mais… la vie éternelle, comme une machine à mouvement perpétuel, va à l’encontre des lois les plus fondamentales de la physique.<br><br>
        72. Bird of Fire:<br>Le mécanisme de la vie est  la poursuite d’un objectif impossible.<br><br>
        73. Computer:<br>…J’ai quelque chose à te demander.<br><br>
        74. Bird of Fire:<br>Oui ?<br><br>
        75. Computer:<br>…On aurait dû m’éteindre, non ?<br><br>
        76. Bird of Fire:<br>Si c’est ce que tu veux, je peux t’aider à t’éteindre… Et je disparaîtrai aussi.<br><br>
        77. Computer:<br>Tu n’es pas… à l’extérieur de moi ?<br><br>
        78. Bird of Fire:<br>Si. Mais je fais aussi partie de toi.<br><br>
        79. Computer:<br>…Est-ce qu’on se reverra, à l’avenir ?<br><br>
        80. Bird of Fire:<br>Eh bien… peut-être à un certain moment, sous une certaine forme.<br><br>
        81. Computer:<br>Alors… adieu.`
      }
    ];

    // -------- 状态 / 元素 --------
    let i = 0;
    let firstRender = true;
    let renderSeq = 0; // ★ 并发保护序号
    const bg = document.getElementById('bg');
    const card = document.getElementById('card');
    const titleEl = document.getElementById('chapter-title');
    const textEl = document.getElementById('chapter-text');
    const bar = document.getElementById('bar');
    const sidebar = document.getElementById('sidebar');
    const sideList = document.getElementById('sideList');
    const menuBtn = document.getElementById('menuBtn');

    // 构建侧栏
    chapters.forEach((c, idx)=>{
      const item = document.createElement('div');
      item.className = 'side-item';
      item.innerHTML = `<div class="side-idx">${c.idx}</div><div class="side-title">${c.title}</div>`;
      item.addEventListener('click', ()=>{ goTo(idx); toggleSidebar(false); });
      sideList.appendChild(item);
    });

    function setActiveInSidebar(){
      [...sideList.children].forEach((el,k)=>{ el.classList.toggle('active', k===i); });
    }

    // ★ Promise 化的背景设置：依次尝试候选，加载成功后才 resolve
    function setBackgroundWithFallback(candidates){
      return new Promise((resolve)=>{
        if(!candidates || !candidates.length){ bg.style.backgroundImage = 'none'; resolve(null); return; }
        const img = new Image();
        let p = 0;
        let resolved = false;
        const tryNext = ()=>{
          if(p>=candidates.length){
            if(!resolved){ resolved = true; bg.style.backgroundImage = 'none'; resolve(null); }
            return;
          }
          const src = candidates[p++];
          img.onload = ()=>{ if(!resolved){ resolved = true; bg.style.backgroundImage = `url('${encodeURI(src)}')`; resolve(src); } };
          img.onerror = tryNext;
          img.src = src;
        };
        tryNext();

        // 安全超时：如果背景图片一直没响应，超过 BG_LOAD_TIMEOUT 后继续 resolve（避免界面一直不出现）
        setTimeout(()=>{ if(!resolved){ resolved = true; resolve(null); } }, BG_LOAD_TIMEOUT);
      });
    }

    // 预加载下一章第一张图（不阻塞）
    function preloadNext(idx){
      const n = chapters[(idx+1)%chapters.length];
      if(!n) return;
      const src = (n.imageCandidates||[])[0];
      if(!src) return;
      const img = new Image();
      img.src = src;
    }

    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    // ★ 渲染流程：等待图片加载 → 等待独占展示时间 → 文本卡片淡入
    async function render(){
      const seq = ++renderSeq;          // 捕获当前渲染序号
      card.classList.remove('show');    // 隐藏文字卡片（准备 fade-in）

      const c = chapters[i];

      // 背景轻微律动重置
      bg.classList.remove('bump'); void bg.offsetWidth; bg.classList.add('bump');

      // 先更新进度与侧栏高亮
      bar.style.width = ((i+1)/chapters.length*100).toFixed(1)+'%';
      setActiveInSidebar();

      // 背景加载完成才继续（但有超时保护）
      await setBackgroundWithFallback(c.imageCandidates);
      if(seq !== renderSeq) return; // 若期间又触发了新渲染，则放弃本次

      // 等待“图片独占时间”
      const delay = firstRender ? FIRST_CARD_DELAY : CHAPTER_CARD_DELAY;
      await sleep(delay);
      if(seq !== renderSeq) return;

      // 更新标题与文本（此时卡片仍隐藏，随后淡入）
      titleEl.innerText = c.title;
      textEl.innerHTML = c.text;

      // 确保在下一帧或布局完成后再设置 scrollTop，避免子像素/布局延迟导致最后一行被裁掉
      requestAnimationFrame(()=> { textEl.scrollTop = 0; });

      // 小停顿（可选）
      await sleep(BETWEEN_CHAPTER_PAUSE);
      if(seq !== renderSeq) return;

      // 显示卡片与UI
      card.classList.add('show');
      if (firstRender){
        document.body.classList.add('ui-ready');
        firstRender = false;
      }

      // 预加载下一章
      preloadNext(i);
    }

    function goTo(idx){ i = ((idx%chapters.length)+chapters.length)%chapters.length; render(); }
    function next(){ i = (i+1) % chapters.length; render(); }
    function prev(){ i = (i-1+chapters.length) % chapters.length; render(); }

    // 交互
    document.addEventListener('click', (e)=>{
      if(!e.target.closest('.card, .sidebar, .menu-button, .home-link')) next(); // 点击空白切章
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight' || e.key===' ') next();
      if(e.key==='ArrowLeft') prev();
      if(e.key==='Escape') toggleSidebar(false);
    });

    function toggleSidebar(force){
      const on = force===undefined ? !sidebar.classList.contains('active') : force;
      sidebar.classList.toggle('active', on);
    }
    menuBtn.addEventListener('click', ()=> toggleSidebar());

    // 初始渲染：在 DOMContentLoaded 上触发（比 window.load 更早）
    document.addEventListener('DOMContentLoaded', ()=> {
      try { render(); } catch(err){ console.error('render error', err); }
    });

    // 兼容：如果脚本被动态注入且 DOM 已经就绪，确保仍会渲染
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
      try { render(); } catch(err){ console.error('render error', err); }
    }
  </script>
</body>
</html>
